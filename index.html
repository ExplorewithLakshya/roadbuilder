<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoadBuilder.io - Perfect for Mobile & Laptop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        
        /* Game Header */
        .game-header {
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f3460;
            z-index: 100;
            flex-shrink: 0;
            min-height: 60px;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
            color: #4cc9f0;
        }
        
        .logo i {
            color: #f72585;
        }
        
        .player-info {
            display: flex;
            gap: 15px;
        }
        
        .info-box {
            background-color: rgba(15, 52, 96, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 90px;
            text-align: center;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #a9b7c6;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4cc9f0;
        }
        
        .score-value {
            color: #f72585;
        }
        
        /* Game Container */
        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* Desktop Layout */
        @media (min-width: 1025px) {
            .game-container {
                flex-direction: row;
            }
            
            .game-sidebar {
                width: 300px;
                display: flex !important;
                flex-direction: column;
            }
            
            .mobile-controls {
                display: none !important;
            }
            
            .mobile-only {
                display: none !important;
            }
        }
        
        /* Tablet Layout */
        @media (min-width: 769px) and (max-width: 1024px) {
            .game-container {
                flex-direction: row;
            }
            
            .game-sidebar {
                width: 260px;
                display: flex !important;
                flex-direction: column;
            }
            
            .mobile-controls {
                display: none !important;
            }
            
            .mobile-only {
                display: none !important;
            }
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .game-sidebar {
                width: 100%;
                height: 200px;
                display: flex !important;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 12px;
                border-right: none;
                border-bottom: 2px solid #0f3460;
            }
            
            .sidebar-section {
                min-width: 260px;
                margin-right: 20px;
                flex-shrink: 0;
            }
            
            .mobile-controls {
                display: flex !important;
            }
            
            .desktop-only {
                display: none !important;
            }
            
            .sidebar-toggle {
                display: none !important;
            }
        }
        
        /* Very Small Mobile */
        @media (max-width: 480px) {
            .game-sidebar {
                height: 180px;
                padding: 10px;
            }
            
            .sidebar-section {
                min-width: 240px;
                margin-right: 15px;
            }
            
            .player-info {
                gap: 8px;
            }
            
            .info-box {
                min-width: 75px;
                padding: 6px 8px;
            }
            
            .info-value {
                font-size: 1.1rem;
            }
        }
        
        /* Game Sidebar */
        .game-sidebar {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-right: 2px solid #0f3460;
            backdrop-filter: blur(10px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.1rem;
            color: #4cc9f0;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #0f3460;
        }
        
        /* Controls */
        .controls-list {
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 10px;
            background-color: rgba(15, 52, 96, 0.3);
            border-radius: 6px;
        }
        
        .control-key {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #4cc9f0;
            font-size: 0.9rem;
        }
        
        /* Upgrades */
        .upgrades-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .upgrade-item {
            background-color: rgba(15, 52, 96, 0.5);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }
        
        .upgrade-item:hover {
            background-color: rgba(79, 120, 173, 0.5);
            border-color: #4cc9f0;
        }
        
        .upgrade-item:active {
            transform: scale(0.98);
        }
        
        .upgrade-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .upgrade-item.disabled:hover {
            background-color: rgba(15, 52, 96, 0.5);
            border-color: transparent;
        }
        
        .upgrade-cost {
            color: #f72585;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        /* Leaderboard */
        .leaderboard-list {
            max-height: 180px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4cc9f0 rgba(15, 52, 96, 0.3);
        }
        
        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .leaderboard-list::-webkit-scrollbar-track {
            background: rgba(15, 52, 96, 0.3);
            border-radius: 3px;
        }
        
        .leaderboard-list::-webkit-scrollbar-thumb {
            background-color: #4cc9f0;
            border-radius: 3px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: rgba(15, 52, 96, 0.3);
            border-radius: 6px;
        }
        
        .leaderboard-item.you {
            background-color: rgba(76, 201, 240, 0.2);
            border-left: 3px solid #f72585;
        }
        
        /* Game Canvas */
        .game-canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #0d1b2a;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Mini-map */
        .mini-map {
            position: absolute;
            bottom: 80px;
            right: 15px;
            width: 150px;
            height: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #4cc9f0;
            border-radius: 8px;
            z-index: 50;
            overflow: hidden;
            display: block !important;
        }
        
        #miniMapCanvas {
            width: 100%;
            height: 100%;
        }
        
        /* Mobile Controls - ALWAYS VISIBLE ON MOBILE */
        .mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 140px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0.7) 70%, transparent 100%);
            z-index: 60;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            touch-action: none;
            pointer-events: auto;
        }
        
        .joystick-container {
            position: relative;
            width: 120px;
            height: 120px;
            touch-action: none;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            border: 2px solid rgba(76, 201, 240, 0.5);
        }
        
        .joystick-handle {
            width: 60px;
            height: 60px;
            background-color: rgba(76, 201, 240, 0.9);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-right: 10px;
        }
        
        .action-button {
            width: 80px;
            height: 80px;
            background-color: rgba(247, 37, 133, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            border: 3px solid white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.1s;
            position: relative;
            user-select: none;
        }
        
        .action-button:active {
            transform: scale(0.95);
            background-color: rgba(247, 37, 133, 1);
        }
        
        .action-button.build {
            background-color: rgba(76, 201, 240, 0.9);
        }
        
        .action-button.build:active {
            background-color: rgba(76, 201, 240, 1);
        }
        
        .action-button.boost {
            background-color: rgba(255, 215, 0, 0.9);
        }
        
        .action-button.boost:active {
            background-color: rgba(255, 215, 0, 1);
        }
        
        .button-label {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: #a9b7c6;
            font-weight: 600;
        }
        
        /* Boost Bar */
        .boost-bar {
            position: absolute;
            bottom: 160px;
            left: 15px;
            width: 180px;
            height: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            z-index: 50;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: block !important;
        }
        
        .boost-fill {
            height: 100%;
            background: linear-gradient(90deg, #4cc9f0, #3a86ff);
            border-radius: 4px;
            width: 100%;
            transition: width 0.2s;
        }
        
        .boost-text {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 0.9rem;
            color: #4cc9f0;
            font-weight: 600;
        }
        
        /* Notification */
        .game-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(15, 52, 96, 0.95);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            min-width: 280px;
            max-width: 90vw;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #4cc9f0;
            pointer-events: none;
        }
        
        .game-notification.show {
            opacity: 1;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(76, 201, 240, 0.3);
            border-top-color: #4cc9f0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #4cc9f0;
            text-align: center;
            margin-bottom: 10px;
        }
        
        /* Mobile Landscape Adjustments */
        @media (max-width: 900px) and (orientation: landscape) {
            .game-container {
                flex-direction: row;
            }
            
            .game-sidebar {
                width: 280px;
                height: 100%;
                flex-direction: column;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .sidebar-section {
                min-width: auto;
                margin-right: 0;
            }
            
            .mobile-controls {
                height: 120px;
                padding: 15px;
            }
            
            .joystick-container {
                width: 100px;
                height: 100px;
            }
            
            .action-button {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .mini-map {
                bottom: 10px;
                width: 120px;
                height: 90px;
            }
            
            .boost-bar {
                bottom: 140px;
                width: 150px;
            }
        }
        
        /* High DPI Screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            canvas {
                image-rendering: -moz-crisp-edges;
                image-rendering: -webkit-crisp-edges;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
            }
        }
        
        /* Performance Optimizations */
        .game-canvas-container {
            -webkit-backface-visibility: hidden;
            -moz-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
        }
        
        /* Player Info Section */
        .player-road-color {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .road-color-indicator {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        .instructions {
            font-size: 0.85rem;
            color: #a9b7c6;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading RoadBuilder.io...</div>
        <div class="loading-text" style="font-size: 0.9rem; margin-top: 10px; color: #a9b7c6;">
            <span id="loadingTip">Use WASD or arrow keys to move</span>
        </div>
    </div>
    
    <div class="game-header">
        <div class="logo">
            <i class="fas fa-road"></i>
            <span>RoadBuilder.io</span>
        </div>
        
        <div class="player-info">
            <div class="info-box">
                <div class="info-label">SCORE</div>
                <div class="info-value score-value" id="score">0</div>
            </div>
            <div class="info-box">
                <div class="info-label">ROAD LENGTH</div>
                <div class="info-value" id="roadLength">0</div>
            </div>
            <div class="info-box">
                <div class="info-label">COINS</div>
                <div class="info-value" id="coins">100</div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <!-- Sidebar -->
        <div class="game-sidebar" id="gameSidebar">
            <!-- Player Info Section -->
            <div class="sidebar-section">
                <div class="section-title">Player Info</div>
                <div class="player-road-color">
                    <div class="road-color-indicator" id="playerColor"></div>
                    <div>Your Road Color</div>
                </div>
                <div class="instructions desktop-only">
                    Use WASD/Arrows to move, SPACE to build roads, SHIFT to boost.
                </div>
                <div class="instructions mobile-only">
                    Use joystick to move, buttons to build and boost.
                </div>
            </div>
            
            <!-- Controls Section -->
            <div class="sidebar-section">
                <div class="section-title">Controls</div>
                <div class="controls-list">
                    <div class="control-item desktop-only">
                        <span>Move</span>
                        <span class="control-key">WASD / Arrows</span>
                    </div>
                    <div class="control-item desktop-only">
                        <span>Build Road</span>
                        <span class="control-key">SPACE</span>
                    </div>
                    <div class="control-item desktop-only">
                        <span>Boost</span>
                        <span class="control-key">SHIFT</span>
                    </div>
                    <div class="control-item mobile-only">
                        <span>Movement</span>
                        <span class="control-key">Joystick</span>
                    </div>
                    <div class="control-item mobile-only">
                        <span>Build Road</span>
                        <span class="control-key">Blue Button</span>
                    </div>
                    <div class="control-item mobile-only">
                        <span>Speed Boost</span>
                        <span class="control-key">Yellow Button</span>
                    </div>
                </div>
            </div>
            
            <!-- Upgrades Section -->
            <div class="sidebar-section">
                <div class="section-title">Upgrades</div>
                <div class="upgrades-list">
                    <div class="upgrade-item" id="upgradeSpeed">
                        <div>
                            <div class="upgrade-name">Speed Boost</div>
                            <div class="upgrade-level">Level <span id="speedLevel">1</span></div>
                        </div>
                        <div class="upgrade-cost">50 coins</div>
                    </div>
                    <div class="upgrade-item" id="upgradeRoadWidth">
                        <div>
                            <div class="upgrade-name">Road Width</div>
                            <div class="upgrade-level">Level <span id="widthLevel">1</span></div>
                        </div>
                        <div class="upgrade-cost">75 coins</div>
                    </div>
                    <div class="upgrade-item" id="upgradeCoinMultiplier">
                        <div>
                            <div class="upgrade-name">Coin Multiplier</div>
                            <div class="upgrade-level">Level <span id="multiplierLevel">1</span></div>
                        </div>
                        <div class="upgrade-cost">100 coins</div>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Section -->
            <div class="sidebar-section">
                <div class="section-title">Leaderboard</div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard items will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Game Canvas -->
        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
            
            <!-- Boost Bar -->
            <div class="boost-bar">
                <div class="boost-text">BOOST</div>
                <div class="boost-fill" id="boostFill"></div>
            </div>
            
            <!-- Mini-map -->
            <div class="mini-map">
                <canvas id="miniMapCanvas"></canvas>
            </div>
            
            <!-- Notification -->
            <div class="game-notification" id="notification">
                Welcome to RoadBuilder.io!
            </div>
            
            <!-- Mobile Controls -->
            <div class="mobile-controls" id="mobileControls">
                <div class="joystick-container">
                    <div class="joystick-base"></div>
                    <div class="joystick-handle" id="joystickHandle"></div>
                </div>
                
                <div class="action-buttons">
                    <div class="action-button build" id="buildButton">
                        <i class="fas fa-road"></i>
                        <div class="button-label">BUILD</div>
                    </div>
                    <div class="action-button boost" id="boostButton">
                        <i class="fas fa-bolt"></i>
                        <div class="button-label">BOOST</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Device detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const screenWidth = window.innerWidth;
        
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const miniMapCanvas = document.getElementById('miniMapCanvas');
        const miniMapCtx = miniMapCanvas.getContext('2d', { alpha: false });
        
        // Game state
        let gameRunning = false;
        let score = 0;
        let roadLength = 0;
        let coins = 100;
        let player = {
            x: 2000,
            y: 2000,
            radius: 15,
            speed: 3,
            roadWidth: 8,
            color: getRandomColor(),
            direction: 0,
            isBuilding: false,
            boost: 1,
            boostCharge: 100,
            maxBoost: 100
        };
        
        // Game objects
        let roads = [];
        let obstacles = [];
        let coinsOnMap = [];
        let otherPlayers = [];
        let particles = [];
        
        // Game settings
        const gameSettings = {
            worldWidth: 4000,
            worldHeight: 4000,
            coinMultiplier: 1,
            roadCost: 0.05, // Reduced cost for mobile play
            coinValue: 1
        };
        
        // Upgrades
        const upgrades = {
            speed: { level: 1, cost: 50, value: 0.5 },
            roadWidth: { level: 1, cost: 75, value: 1 },
            coinMultiplier: { level: 1, cost: 100, value: 0.2 }
        };
        
        // Leaderboard
        let leaderboard = [
            { name: "RoadMaster", score: 24500, color: "#ff0000" },
            { name: "HighwayKing", score: 18900, color: "#00ff00" },
            { name: "AsphaltPro", score: 15600, color: "#0000ff" },
            { name: "You", score: 0, color: player.color },
            { name: "RoadRacer", score: 9800, color: "#ffff00" },
            { name: "PathFinder", score: 7600, color: "#ff00ff" },
            { name: "TrailBlazer", score: 5400, color: "#00ffff" }
        ];
        
        // Input handling
        const keys = {};
        let joystickActive = false;
        let joystickTouchId = null;
        let joystickCenter = { x: 0, y: 0 };
        let joystickRadius = 50;
        let joystickVector = { x: 0, y: 0 };
        
        // Performance
        let lastRenderTime = 0;
        const fps = 60;
        const frameInterval = 1000 / fps;
        
        // Initialize game
        async function init() {
            // Show loading screen
            showLoadingTip();
            
            // Set canvas dimensions
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Set player color
            document.getElementById('playerColor').style.backgroundColor = player.color;
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize game objects
            generateInitialRoad();
            generateObstacles(25);
            generateCoins(40);
            generateOtherPlayers(5);
            
            // Update UI
            updateUI();
            updateLeaderboard();
            updateUpgradeButtons();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    gameRunning = true;
                    showNotification("Welcome! Build roads to earn points.", "#4cc9f0");
                    requestAnimationFrame(gameLoop);
                }, 500);
            }, 1000);
        }
        
        // Show loading tip
        function showLoadingTip() {
            const desktopTips = [
                "Use WASD or arrow keys to move",
                "Press SPACE to build roads",
                "Hold SHIFT to boost your speed",
                "Collect coins for upgrades",
                "Avoid obstacles to keep your score"
            ];
            
            const mobileTips = [
                "Use joystick to move",
                "Tap BUILD button to create roads",
                "Tap BOOST for speed burst",
                "Collect coins for upgrades",
                "Swipe sidebar to see more info"
            ];
            
            const tips = isMobile ? mobileTips : desktopTips;
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('loadingTip').textContent = randomTip;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Keyboard controls for desktop
            window.addEventListener('keydown', (e) => {
                if ([' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd', 'Shift'].includes(e.key)) {
                    e.preventDefault();
                }
                
                const key = e.key.toLowerCase();
                keys[key] = true;
                
                if (e.key === ' ' && !e.repeat) {
                    player.isBuilding = true;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                keys[key] = false;
                
                if (e.key === ' ') {
                    player.isBuilding = false;
                }
            });
            
            // Mouse controls for desktop
            if (!isTouchDevice) {
                canvas.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    if (e.button === 0) {
                        player.isBuilding = true;
                    }
                });
                
                canvas.addEventListener('mouseup', (e) => {
                    if (e.button === 0) {
                        player.isBuilding = false;
                    }
                });
                
                canvas.addEventListener('mouseleave', () => {
                    player.isBuilding = false;
                });
            }
            
            // Touch controls for mobile
            if (isTouchDevice) {
                // Prevent default touch behaviors
                document.addEventListener('touchmove', (e) => {
                    if (e.target.closest('.game-canvas-container') || 
                        e.target.closest('.mobile-controls')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Setup joystick
                const joystickContainer = document.querySelector('.joystick-container');
                const joystickHandle = document.getElementById('joystickHandle');
                
                joystickContainer.addEventListener('touchstart', handleJoystickStart);
                joystickContainer.addEventListener('touchmove', handleJoystickMove);
                joystickContainer.addEventListener('touchend', handleJoystickEnd);
                joystickContainer.addEventListener('touchcancel', handleJoystickEnd);
                
                // Setup action buttons
                const buildButton = document.getElementById('buildButton');
                const boostButton = document.getElementById('boostButton');
                
                buildButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    player.isBuilding = true;
                    buildButton.style.transform = 'scale(0.95)';
                });
                
                buildButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    player.isBuilding = false;
                    buildButton.style.transform = 'scale(1)';
                });
                
                buildButton.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    player.isBuilding = false;
                    buildButton.style.transform = 'scale(1)';
                });
                
                boostButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    keys['shift'] = true;
                    boostButton.style.transform = 'scale(0.95)';
                });
                
                boostButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys['shift'] = false;
                    boostButton.style.transform = 'scale(1)';
                });
                
                boostButton.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    keys['shift'] = false;
                    boostButton.style.transform = 'scale(1)';
                });
                
                // Show mobile controls
                document.getElementById('mobileControls').style.display = 'flex';
            }
            
            // Upgrade buttons
            document.getElementById('upgradeSpeed').addEventListener('click', () => buyUpgrade('speed'));
            document.getElementById('upgradeRoadWidth').addEventListener('click', () => buyUpgrade('roadWidth'));
            document.getElementById('upgradeCoinMultiplier').addEventListener('click', () => buyUpgrade('coinMultiplier'));
            
            // Prevent zoom on mobile
            document.addEventListener('gesturestart', (e) => e.preventDefault());
        }
        
        // Joystick handlers
        function handleJoystickStart(e) {
            e.preventDefault();
            if (joystickTouchId !== null) return;
            
            const touch = e.touches[0];
            joystickTouchId = touch.identifier;
            
            const rect = e.target.getBoundingClientRect();
            joystickCenter.x = rect.left + rect.width / 2;
            joystickCenter.y = rect.top + rect.height / 2;
            
            joystickActive = true;
            updateJoystick(touch);
        }
        
        function handleJoystickMove(e) {
            e.preventDefault();
            if (!joystickActive) return;
            
            for (let i = 0; i < e.touches.length; i++) {
                if (e.touches[i].identifier === joystickTouchId) {
                    updateJoystick(e.touches[i]);
                    break;
                }
            }
        }
        
        function handleJoystickEnd(e) {
            e.preventDefault();
            
            if (e.type === 'touchend') {
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === joystickTouchId) {
                        resetJoystick();
                        break;
                    }
                }
            } else {
                resetJoystick();
            }
        }
        
        function updateJoystick(touch) {
            const touchX = touch.clientX;
            const touchY = touch.clientY;
            
            const deltaX = touchX - joystickCenter.x;
            const deltaY = touchY - joystickCenter.y;
            
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle = Math.atan2(deltaY, deltaX);
            
            let joystickX = deltaX;
            let joystickY = deltaY;
            
            if (distance > joystickRadius) {
                joystickX = Math.cos(angle) * joystickRadius;
                joystickY = Math.sin(angle) * joystickRadius;
            }
            
            // Update joystick handle
            const joystickHandle = document.getElementById('joystickHandle');
            joystickHandle.style.transform = `translate(calc(-50% + ${joystickX}px), calc(-50% + ${joystickY}px))`;
            
            // Calculate joystick vector
            joystickVector.x = joystickX / joystickRadius;
            joystickVector.y = joystickY / joystickRadius;
            
            // Update movement
            keys['arrowleft'] = joystickVector.x < -0.1;
            keys['arrowright'] = joystickVector.x > 0.1;
            keys['arrowup'] = joystickVector.y < -0.1;
            keys['arrowdown'] = joystickVector.y > 0.1;
        }
        
        function resetJoystick() {
            joystickActive = false;
            joystickTouchId = null;
            joystickVector.x = 0;
            joystickVector.y = 0;
            
            const joystickHandle = document.getElementById('joystickHandle');
            joystickHandle.style.transform = 'translate(-50%, -50%)';
            
            keys['arrowleft'] = false;
            keys['arrowright'] = false;
            keys['arrowup'] = false;
            keys['arrowdown'] = false;
        }
        
        // Resize canvas
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            
            miniMapCanvas.width = document.querySelector('.mini-map').clientWidth;
            miniMapCanvas.height = document.querySelector('.mini-map').clientHeight;
        }
        
        // Game loop
        function gameLoop(timestamp) {
            if (!gameRunning) return;
            
            const deltaTime = timestamp - lastRenderTime;
            
            if (deltaTime >= frameInterval) {
                lastRenderTime = timestamp - (deltaTime % frameInterval);
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Calculate camera
                const cameraX = player.x - canvas.width / 2;
                const cameraY = player.y - canvas.height / 2;
                
                // Handle input
                handleInput();
                
                // Update game state
                updatePlayer();
                updateCoins();
                updateOtherPlayers();
                updateParticles();
                
                // Draw everything
                drawRoads(cameraX, cameraY);
                drawObstacles(cameraX, cameraY);
                drawCoins(cameraX, cameraY);
                drawOtherPlayers(cameraX, cameraY);
                drawParticles(cameraX, cameraY);
                drawPlayer(cameraX, cameraY);
                
                // Draw minimap
                drawMiniMap();
                
                // Update UI
                updateUI();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Handle input
        function handleInput() {
            let moveX = 0;
            let moveY = 0;
            
            // Keyboard controls
            if (keys['w'] || keys['arrowup']) moveY -= 1;
            if (keys['s'] || keys['arrowdown']) moveY += 1;
            if (keys['a'] || keys['arrowleft']) moveX -= 1;
            if (keys['d'] || keys['arrowright']) moveX += 1;
            
            // Joystick controls (overrides keyboard)
            if (joystickActive) {
                moveX = joystickVector.x;
                moveY = joystickVector.y;
                
                // Apply deadzone
                if (Math.abs(moveX) < 0.1) moveX = 0;
                if (Math.abs(moveY) < 0.1) moveY = 0;
            }
            
            // Normalize diagonal movement
            if (moveX !== 0 && moveY !== 0) {
                moveX *= 0.7071;
                moveY *= 0.7071;
            }
            
            // Apply boost
            let currentSpeed = player.speed;
            if ((keys['shift'] || keys['shiftright']) && player.boostCharge > 0) {
                currentSpeed *= 1.8;
                player.boostCharge = Math.max(0, player.boostCharge - 1.5);
                
                if (Math.random() < 0.3) {
                    createParticles(player.x, player.y, player.color, 2);
                }
            } else if (player.boostCharge < player.maxBoost) {
                player.boostCharge = Math.min(player.maxBoost, player.boostCharge + 0.5);
            }
            
            // Update player position
            player.x += moveX * currentSpeed;
            player.y += moveY * currentSpeed;
            
            // Keep in bounds
            player.x = Math.max(player.radius, Math.min(gameSettings.worldWidth - player.radius, player.x));
            player.y = Math.max(player.radius, Math.min(gameSettings.worldHeight - player.radius, player.y));
            
            // Update direction
            if (moveX !== 0 || moveY !== 0) {
                player.direction = Math.atan2(moveY, moveX);
            }
            
            // Build road
            if (player.isBuilding && coins >= gameSettings.roadCost) {
                addRoadSegment();
                coins -= gameSettings.roadCost;
            }
        }
        
        // Update player
        function updatePlayer() {
            // Check collision with obstacles
            for (const obstacle of obstacles) {
                const dx = player.x - obstacle.x;
                const dy = player.y - obstacle.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.radius + obstacle.radius) {
                    const angle = Math.atan2(dy, dx);
                    player.x += Math.cos(angle) * 2;
                    player.y += Math.sin(angle) * 2;
                    
                    score = Math.max(0, score - 5);
                    showNotification("Hit obstacle! -5 points", "#f72585");
                    createParticles(player.x, player.y, obstacle.color, 3);
                }
            }
        }
        
        // Add road segment
        function addRoadSegment() {
            if (roads.length === 0) {
                roads.push({
                    points: [{x: player.x, y: player.y}],
                    color: player.color,
                    width: player.roadWidth
                });
            } else {
                const lastRoad = roads[roads.length - 1];
                const lastPoint = lastRoad.points[lastRoad.points.length - 1];
                
                const dx = player.x - lastPoint.x;
                const dy = player.y - lastPoint.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    lastRoad.points.push({x: player.x, y: player.y});
                    roadLength += distance;
                    score += Math.floor(distance * 0.1);
                    
                    if (Math.random() < 0.02) {
                        generateCoin(player.x, player.y);
                    }
                    
                    if (Math.random() < 0.1) {
                        createParticles(player.x, player.y, player.color, 1);
                    }
                }
            }
        }
        
        // Update coins
        function updateCoins() {
            for (let i = coinsOnMap.length - 1; i >= 0; i--) {
                const coin = coinsOnMap[i];
                
                const dx = player.x - coin.x;
                const dy = player.y - coin.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.radius + coin.radius) {
                    const coinValue = gameSettings.coinValue * gameSettings.coinMultiplier;
                    coins += coinValue;
                    score += Math.floor(coinValue * 10);
                    
                    createParticles(coin.x, coin.y, "#FFD700", 5);
                    showNotification(`+${coinValue.toFixed(1)} coins`, "#FFD700");
                    
                    coinsOnMap.splice(i, 1);
                    generateCoin();
                }
            }
        }
        
        // Update other players
        function updateOtherPlayers() {
            for (const other of otherPlayers) {
                if (Math.random() < 0.02) {
                    other.direction = Math.random() * Math.PI * 2;
                }
                
                other.x += Math.cos(other.direction) * other.speed;
                other.y += Math.sin(other.direction) * other.speed;
                
                if (other.x < other.radius || other.x > gameSettings.worldWidth - other.radius) {
                    other.direction = Math.PI - other.direction;
                }
                if (other.y < other.radius || other.y > gameSettings.worldHeight - other.radius) {
                    other.direction = -other.direction;
                }
                
                if (Math.random() < 0.1) {
                    other.roadPoints.push({x: other.x, y: other.y});
                    
                    if (other.roadPoints.length > 50) {
                        other.roadPoints.shift();
                    }
                }
            }
        }
        
        // Update particles
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 1;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        // Draw roads
        function drawRoads(cameraX, cameraY) {
            for (const road of roads) {
                if (road.points.length < 2) continue;
                
                ctx.beginPath();
                ctx.moveTo(road.points[0].x - cameraX, road.points[0].y - cameraY);
                
                for (let i = 1; i < road.points.length; i++) {
                    ctx.lineTo(road.points[i].x - cameraX, road.points[i].y - cameraY);
                }
                
                ctx.strokeStyle = road.color;
                ctx.lineWidth = road.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }
            
            for (const other of otherPlayers) {
                if (other.roadPoints.length < 2) continue;
                
                ctx.beginPath();
                ctx.moveTo(other.roadPoints[0].x - cameraX, other.roadPoints[0].y - cameraY);
                
                for (let i = 1; i < other.roadPoints.length; i++) {
                    ctx.lineTo(other.roadPoints[i].x - cameraX, other.roadPoints[i].y - cameraY);
                }
                
                ctx.strokeStyle = other.color + "80";
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }
        }
        
        // Draw obstacles
        function drawObstacles(cameraX, cameraY) {
            for (const obstacle of obstacles) {
                ctx.beginPath();
                ctx.arc(obstacle.x - cameraX, obstacle.y - cameraY, obstacle.radius, 0, Math.PI * 2);
                ctx.fillStyle = obstacle.color;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(obstacle.x - cameraX, obstacle.y - cameraY, obstacle.radius * 0.7, 0, Math.PI * 2);
                ctx.strokeStyle = "#000000";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        // Draw coins
        function drawCoins(cameraX, cameraY) {
            for (const coin of coinsOnMap) {
                ctx.beginPath();
                ctx.arc(coin.x - cameraX, coin.y - cameraY, coin.radius, 0, Math.PI * 2);
                ctx.fillStyle = "#FFD700";
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(coin.x - cameraX - coin.radius * 0.3, coin.y - cameraY - coin.radius * 0.3, coin.radius * 0.4, 0, Math.PI * 2);
                ctx.fillStyle = "#FFF8DC";
                ctx.fill();
                
                ctx.fillStyle = "#B8860B";
                ctx.font = `${coin.radius * 1.2}px Arial`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("$", coin.x - cameraX, coin.y - cameraY);
                
                coin.y += Math.sin(Date.now() * 0.003 + coin.x) * 0.1;
            }
        }
        
        // Draw other players
        function drawOtherPlayers(cameraX, cameraY) {
            for (const other of otherPlayers) {
                ctx.beginPath();
                ctx.arc(other.x - cameraX, other.y - cameraY, other.radius, 0, Math.PI * 2);
                ctx.fillStyle = other.color;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(other.x - cameraX, other.y - cameraY, other.radius, 0, Math.PI * 2);
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(other.x - cameraX, other.y - cameraY);
                ctx.lineTo(
                    other.x - cameraX + Math.cos(other.direction) * other.radius * 1.5,
                    other.y - cameraY + Math.sin(other.direction) * other.radius * 1.5
                );
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 3;
                ctx.stroke();
            }
        }
        
        // Draw particles
        function drawParticles(cameraX, cameraY) {
            for (const p of particles) {
                ctx.beginPath();
                ctx.arc(p.x - cameraX, p.y - cameraY, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / p.maxLife;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }
        
        // Draw player
        function drawPlayer(cameraX, cameraY) {
            ctx.beginPath();
            ctx.arc(player.x - cameraX, player.y - cameraY, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = player.color;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(player.x - cameraX, player.y - cameraY, player.radius, 0, Math.PI * 2);
            ctx.strokeStyle = "#FFFFFF";
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(player.x - cameraX, player.y - cameraY);
            ctx.lineTo(
                player.x - cameraX + Math.cos(player.direction) * player.radius * 1.5,
                player.y - cameraY + Math.sin(player.direction) * player.radius * 1.5
            );
            ctx.strokeStyle = "#FFFFFF";
            ctx.lineWidth = 4;
            ctx.stroke();
            
            if (player.isBuilding) {
                ctx.beginPath();
                ctx.arc(player.x - cameraX, player.y - cameraY, player.radius + 5, 0, Math.PI * 2);
                ctx.strokeStyle = player.color + "80";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        // Draw minimap
        function drawMiniMap() {
            const width = miniMapCanvas.width;
            const height = miniMapCanvas.height;
            
            miniMapCtx.fillStyle = "rgba(13, 27, 42, 0.9)";
            miniMapCtx.fillRect(0, 0, width, height);
            
            const scaleX = width / gameSettings.worldWidth;
            const scaleY = height / gameSettings.worldHeight;
            const scale = Math.min(scaleX, scaleY);
            
            // Draw roads
            for (const road of roads) {
                if (road.points.length < 2) continue;
                
                miniMapCtx.beginPath();
                miniMapCtx.moveTo(road.points[0].x * scale, road.points[0].y * scale);
                
                for (let i = 1; i < road.points.length; i++) {
                    miniMapCtx.lineTo(road.points[i].x * scale, road.points[i].y * scale);
                }
                
                miniMapCtx.strokeStyle = road.color;
                miniMapCtx.lineWidth = 2;
                miniMapCtx.stroke();
            }
            
            // Draw obstacles
            for (const obstacle of obstacles) {
                miniMapCtx.beginPath();
                miniMapCtx.arc(obstacle.x * scale, obstacle.y * scale, Math.max(2, obstacle.radius * scale * 0.3), 0, Math.PI * 2);
                miniMapCtx.fillStyle = obstacle.color;
                miniMapCtx.fill();
            }
            
            // Draw other players
            for (const other of otherPlayers) {
                miniMapCtx.beginPath();
                miniMapCtx.arc(other.x * scale, other.y * scale, 3, 0, Math.PI * 2);
                miniMapCtx.fillStyle = other.color;
                miniMapCtx.fill();
            }
            
            // Draw player
            miniMapCtx.beginPath();
            miniMapCtx.arc(player.x * scale, player.y * scale, 4, 0, Math.PI * 2);
            miniMapCtx.fillStyle = "#FFFFFF";
            miniMapCtx.fill();
            
            // Draw viewport
            const viewportWidth = canvas.width * scale;
            const viewportHeight = canvas.height * scale;
            const viewportX = (player.x - canvas.width / 2) * scale;
            const viewportY = (player.y - canvas.height / 2) * scale;
            
            miniMapCtx.strokeStyle = "#4cc9f0";
            miniMapCtx.lineWidth = 2;
            miniMapCtx.strokeRect(viewportX, viewportY, viewportWidth, viewportHeight);
        }
        
        // Generate initial road
        function generateInitialRoad() {
            roads.push({
                points: [
                    {x: player.x - 100, y: player.y},
                    {x: player.x, y: player.y}
                ],
                color: player.color,
                width: player.roadWidth
            });
            
            roadLength = 100;
        }
        
        // Generate obstacles
        function generateObstacles(count) {
            for (let i = 0; i < count; i++) {
                obstacles.push({
                    x: Math.random() * gameSettings.worldWidth,
                    y: Math.random() * gameSettings.worldHeight,
                    radius: 20 + Math.random() * 30,
                    color: getRandomObstacleColor()
                });
            }
        }
        
        // Generate coins
        function generateCoins(count) {
            for (let i = 0; i < count; i++) {
                generateCoin();
            }
        }
        
        // Generate a single coin
        function generateCoin(x, y) {
            if (x === undefined || y === undefined) {
                x = Math.random() * gameSettings.worldWidth;
                y = Math.random() * gameSettings.worldHeight;
                
                const dx = x - player.x;
                const dy = y - player.y;
                if (Math.sqrt(dx * dx + dy * dy) < 200) {
                    return generateCoin();
                }
            }
            
            coinsOnMap.push({
                x: x,
                y: y,
                radius: 8 + Math.random() * 4
            });
        }
        
        // Generate other players
        function generateOtherPlayers(count) {
            for (let i = 0; i < count; i++) {
                otherPlayers.push({
                    x: Math.random() * gameSettings.worldWidth,
                    y: Math.random() * gameSettings.worldHeight,
                    radius: 12 + Math.random() * 6,
                    speed: 1.5 + Math.random() * 1.5,
                    color: getRandomColor(),
                    direction: Math.random() * Math.PI * 2,
                    name: getRandomPlayerName(),
                    roadPoints: []
                });
            }
        }
        
        // Create particles
        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 2;
                const life = 20 + Math.random() * 30;
                
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: 2 + Math.random() * 3,
                    color: color,
                    life: life,
                    maxLife: life
                });
            }
        }
        
        // Buy upgrade
        function buyUpgrade(type) {
            const upgrade = upgrades[type];
            
            if (coins >= upgrade.cost) {
                coins -= upgrade.cost;
                upgrade.level++;
                
                if (type === 'speed') {
                    player.speed += upgrade.value;
                    showNotification(`Speed increased to ${player.speed.toFixed(1)}`, "#4cc9f0");
                } else if (type === 'roadWidth') {
                    player.roadWidth += upgrade.value;
                    showNotification(`Road width increased to ${player.roadWidth.toFixed(1)}`, "#4cc9f0");
                } else if (type === 'coinMultiplier') {
                    gameSettings.coinMultiplier += upgrade.value;
                    showNotification(`Coin multiplier increased to ${gameSettings.coinMultiplier.toFixed(1)}x`, "#4cc9f0");
                }
                
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                updateUI();
                updateUpgradeButtons();
            } else {
                showNotification(`Need ${upgrade.cost} coins!`, "#f72585");
            }
        }
        
        // Update UI
        function updateUI() {
            document.getElementById('score').textContent = Math.floor(score);
            document.getElementById('roadLength').textContent = Math.floor(roadLength);
            document.getElementById('coins').textContent = Math.floor(coins);
            
            // Update boost bar
            const boostFill = document.getElementById('boostFill');
            boostFill.style.width = `${(player.boostCharge / player.maxBoost) * 100}%`;
            
            // Update upgrade levels
            document.getElementById('speedLevel').textContent = upgrades.speed.level;
            document.getElementById('widthLevel').textContent = upgrades.roadWidth.level;
            document.getElementById('multiplierLevel').textContent = upgrades.coinMultiplier.level;
            
            // Update upgrade costs
            document.querySelector('#upgradeSpeed .upgrade-cost').textContent = `${upgrades.speed.cost} coins`;
            document.querySelector('#upgradeRoadWidth .upgrade-cost').textContent = `${upgrades.roadWidth.cost} coins`;
            document.querySelector('#upgradeCoinMultiplier .upgrade-cost').textContent = `${upgrades.coinMultiplier.cost} coins`;
            
            // Update leaderboard
            const playerEntry = leaderboard.find(entry => entry.name === "You");
            if (playerEntry) {
                playerEntry.score = score;
                playerEntry.color = player.color;
                updateLeaderboard();
            }
        }
        
        // Update upgrade buttons
        function updateUpgradeButtons() {
            const speedUpgrade = document.getElementById('upgradeSpeed');
            const widthUpgrade = document.getElementById('upgradeRoadWidth');
            const multiplierUpgrade = document.getElementById('upgradeCoinMultiplier');
            
            speedUpgrade.classList.toggle('disabled', coins < upgrades.speed.cost);
            widthUpgrade.classList.toggle('disabled', coins < upgrades.roadWidth.cost);
            multiplierUpgrade.classList.toggle('disabled', coins < upgrades.coinMultiplier.cost);
        }
        
        // Update leaderboard
        function updateLeaderboard() {
            leaderboard.sort((a, b) => b.score - a.score);
            
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            for (let i = 0; i < Math.min(leaderboard.length, 7); i++) {
                const player = leaderboard[i];
                const item = document.createElement('div');
                item.className = `leaderboard-item ${player.name === "You" ? "you" : ""}`;
                item.innerHTML = `
                    <div class="player-rank">${i + 1}</div>
                    <div class="player-name">${player.name}</div>
                    <div class="player-score">${Math.floor(player.score)}</div>
                `;
                leaderboardList.appendChild(item);
            }
        }
        
        // Show notification
        function showNotification(message, color) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = color;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }
        
        // Helper functions
        function getRandomColor() {
            const colors = [
                '#4cc9f0', '#f72585', '#7209b7', '#3a86ff', 
                '#ffbe0b', '#06d6a0', '#118ab2', '#ef476f'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function getRandomObstacleColor() {
            const colors = [
                '#8B4513', '#A0522D', '#CD853F', '#D2691E',
                '#A52A2A', '#800000', '#8B0000'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function getRandomPlayerName() {
            const names = [
                'RoadRunner', 'HighwayHero', 'AsphaltAce', 'PathPioneer',
                'TrailTamer', 'RoadRacer', 'StreetSmasher', 'LaneLegend'
            ];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        // Initialize game
        window.onload = init;
        
        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            gameRunning = !document.hidden;
            if (gameRunning) {
                lastRenderTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        });
    </script>
</body>
</html>
